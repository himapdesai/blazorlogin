@page "/errors"
@using ErrorBlazorLoginApp.Models
@using ErrorBlazorLoginApp.Services
@inject ErrorService ErrorService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@attribute [Authorize]

<div class="container py-3">
    <div class="row mb-3">
        <div class="col-12 col-md-6">
            <h3>Error list</h3>
        </div>
        <div class="col-12 col-md-6">
            <div class="d-flex gap-2 justify-content-md-end align-items-center">
                <label class="form-label mb-0">Status:</label>
                <InputSelect class="form-select" style="max-width:220px" @bind-Value="selectedStatus">
                    <option value="">All</option>
                    @foreach (var s in statuses)
                    {
                        <option value="@s">@s</option>
                    }
                </InputSelect>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-4">
            <div class="spinner-border" role="status"></div>
            <div class="mt-2">Loading</div>
        </div>
    }
    else if (!Errors.Any())
    {
        <div class="alert alert-info">No errors here</div>
    }
    else
    {
        @if (!FilteredErrors.Any())
        {
            <div class="alert alert-warning">No matching errors for the selected status.</div>
        }
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Description</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var err in FilteredErrors)
                    {
                        <tr>
                            <td>@err.Title</td>
                            <td>@FormatDate(err.Date)</td>
                            <td>@err.Status</td>
                            <td class="text-truncate" style="max-width:320px;">@err.Description</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-primary me-1" @onclick="() => Edit(err.ID)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(err.ID, err.Title)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-block d-sm-none">
            @foreach (var err in FilteredErrors)
            {
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">@err.Title</h6>
                            <small class="text-muted">@FormatDate(err.Date)</small>
                        </div>
                        <p class="mb-1">@err.Status</p>
                        <p class="small mb-2">@err.Description</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" @onclick="() => Edit(err.ID)">Edit</button>
                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(err.ID, err.Title)">Delete</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    <div class="mt-3">
        <button class="btn btn-primary" @onclick="Add">Add</button>
    </div>
</div>

@code {
    private List<Error> Errors { get; set; } = new();
    private bool isLoading = false;
    private List<string> statuses = new();
    private string? selectedStatus = string.Empty;
    private IEnumerable<Error> FilteredErrors => string.IsNullOrEmpty(selectedStatus)
        ? Errors
        : Errors.Where(e => e.Status == selectedStatus);

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var list = await ErrorService.GetErrors();
            Errors = list?.ToList() ?? new List<Error>();
            statuses = Errors
                .Select(e => e.Status)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .OrderBy(s => s)
                .ToList();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void Edit(int id)
    {
        NavigationManager.NavigateTo($"/edit/{id}");
    }

    private async Task ConfirmDelete(int id, string title)
    {
        var ok = await JSRuntime.InvokeAsync<bool>("confirm", $"Delete '{title}'?");
        if (!ok) return;
        await Delete(id);
    }

    private async Task Delete(int id)
    {
        try
        {
            await ErrorService.DeleteError(id);
            var toRemove = Errors.FirstOrDefault(x => x.ID == id);
            if (toRemove != null) Errors.Remove(toRemove);
            StateHasChanged();
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", "Delete failed");
        }
    }

    private string FormatDate(string? ds)
    {
        if (string.IsNullOrWhiteSpace(ds)) return "-";
        if (DateTime.TryParse(ds, out var dt)) return dt.ToLocalTime().ToString("dd-MMM-yyyy hh:mm tt");
        return ds;
    }

    private void Add()
    {
        NavigationManager.NavigateTo("/add");
    }
}